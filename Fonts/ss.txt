const mainDisplay = document.getElementById("display");
const historyDisplay = document.getElementById("historyContent");

let memoryValue = 0; // مقدار ذخیره‌شده
let currentOperator = null; // عملگر فعلی
let isCalculated = false; // پرچم: آیا محاسبه انجام شده؟
let lastInput = ''; // آخرین ورودی

// افزودن عدد به نمایشگر
function appendNumber(input) {
    if (isCalculated) {
        isCalculated = false;
        mainDisplay.value = input; // شروع یک عدد جدید
    } else {
        if (mainDisplay.value === "0" || mainDisplay.value === "Error!" || mainDisplay.value === "Infinity") {
            mainDisplay.value = input; // تنظیم مقدار از صفر شروع می‌شود
        } else {
            // جلوگیری از اضافه شدن بیش از 11 رقم
            if (mainDisplay.value.replace('.', '').length < 11) { // ******* تغییر: اضافه کردن محدودیت 11 رقم
                mainDisplay.value += input;
            }
        }
    }
    lastInput = 'number';
}

// افزودن عملگر
function appendOperator(input) {
    const operators = ['+', '-', '*', '/', '^2', 'sqrt', 'cos'];

    if (lastInput === 'number') {
        if (input === 'sqrt') {
            mainDisplay.value = parseFloat(Math.sqrt(mainDisplay.value).toFixed(4));
            lastInput = 'number';
        } else if (input === 'cos') {
            const angle = mainDisplay.value;
            mainDisplay.value = parseFloat(Math.cos(angle * (Math.PI / 180)).toFixed(4));
            lastInput = 'number';
        } else if (input === 'pm') {
            mainDisplay.value = -mainDisplay.value;
            lastInput = 'number';
        } else if (input === '^2') {
            mainDisplay.value = Math.pow(mainDisplay.value, 2);
            lastInput = 'number';
        } else if (input === 'Backspace') {
            mainDisplay.value = mainDisplay.value.slice(0, -1);
        } else {
            // ذخیره عملگر و مقدار فعلی برای محاسبه
            if (currentOperator !== null) {  // اگر قبلاً عملگری وجود دارد، محاسبه کن
                calculate();  // ******* تغییر: اضافه کردن محاسبه در صورت وارد شدن عملگر جدید
            }
            memoryValue = parseFloat(mainDisplay.value); // ******* تغییر: ذخیره مقدار در حافظه
            currentOperator = input; // ******* تغییر: ذخیره عملگر
            historyDisplay.innerHTML += `${memoryValue} ${currentOperator} `; // ******* تغییر: نمایش تاریخچه به‌طور لحظه‌ای
            mainDisplay.value = ''; // ******* تغییر: پاک کردن نمایشگر برای وارد کردن عدد بعدی
            lastInput = 'operator';
        }
    } else if (lastInput === 'operator' && operators.includes(input)) {
        // به‌روزرسانی عملگر
        currentOperator = input; // ******* تغییر: به‌روزرسانی عملگر
        historyDisplay.innerHTML = historyDisplay.innerHTML.slice(0, -2); // ******* تغییر: حذف آخرین عملگر
        historyDisplay.innerHTML += `${currentOperator} `; // ******* تغییر: نمایش عملگر جدید
    }
}

// پاک کردن صفحه نمایش
function clearDisplay() {
    mainDisplay.value = '0';
    historyDisplay.innerHTML = '';
    memoryValue = 0;
    currentOperator = null;
    isCalculated = false;
    lastInput = 'number';
}

// انجام محاسبات
function calculate() {
    try {
        if (!currentOperator || lastInput === 'operator') return; // جلوگیری از محاسبه ناقص

        const currentValue = parseFloat(mainDisplay.value);
        let result;

        switch (currentOperator) {
            case '+':
                result = memoryValue + currentValue;
                break;
            case '-':
                result = memoryValue - currentValue;
                break;
            case '*':
                result = memoryValue * currentValue;
                break;
            case '/':
                if (currentValue === 0) throw new Error("Division by zero");
                result = memoryValue / currentValue;
                break;
            default:
                throw new Error("Invalid operator");
        }

        // نمایش تاریخچه
        historyDisplay.innerHTML += `${currentValue} = ${result} <br>`; // ******* تغییر: نمایش عملیات نهایی در تاریخچه
        mainDisplay.value = result.toFixed(4); // نمایش نتیجه در صفحه اصلی
        memoryValue = result; // به‌روزرسانی مقدار ذخیره‌شده
        currentOperator = null; // ریست عملگر
        isCalculated = true; // تنظیم پرچم محاسبه
    } catch (error) {
        mainDisplay.value = "Error!";
        historyDisplay.innerHTML = '';
        memoryValue = 0;
        currentOperator = null;
    }
}

// در نظر گرفتن ورودی کیبورد
document.addEventListener('keydown', function (event) {
    event.preventDefault();
    if (!isNaN(event.key)) {
        appendNumber(event.key);
    } else if (['+', '-', '*', '/'].includes(event.key)) {
        appendOperator(event.key);
    } else if (event.key === 'Enter') {
        calculate();
    } else if (event.key === 'Backspace') {
        appendOperator('Backspace');
    } else if (event.key.toLowerCase() === 'c') {
        clearDisplay();
    }
});
